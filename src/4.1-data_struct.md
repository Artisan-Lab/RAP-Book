# Chatper 4.1 Key Data Structures of Rust Compiler

## Toy Example

**Source Rust code**
```rust
fn main() {
    let bob = Box::new(1); 
}
```

**HIR**
Obtain the HIR of the source code 
```
cargo rustc -- -Z unpretty=hir-tree
```
```
Crate {
    owners: [
        Owner(
            OwnerInfo {
                nodes: OwnerNodes {
                    node: Some(
                        ParentedNode {
                            parent: 4294967040,
                            node: Crate(
                                Mod {
                                    spans: ModSpans {
                                        inner_span: src/main.rs:1:1: 3:2 (#0),
                                        inject_use_span: no-location (#0),
                                    },
                                    item_ids: [
                                        ItemId {
                                            owner_id: DefId(0:1 ~ toy[5100]::{use#0}),
                                        },
                                        ItemId {
                                            owner_id: DefId(0:2 ~ toy[5100]::std),
                                        },
                                        ItemId {
                                            owner_id: DefId(0:3 ~ toy[5100]::main),
                                        },
                                    ],
                                },
                            ),
                        },
                    ),
                    parents: [
                        (0, Some(4294967040)),
                    ],
                    bodies: {},
                    opt_hash_including_bodies: Some(
                        Fingerprint(
                            17701251796497859289,
                            6289988835997483942,
                        ),
                    ),
                },
                parenting: {
                    DefId(0:1 ~ toy[5100]::{use#0}): 0,
                    DefId(0:2 ~ toy[5100]::std): 0,
                    DefId(0:3 ~ toy[5100]::main): 0,
                },
                attrs: AttributeMap {
                    map: {},
                    opt_hash: Some(
                        Fingerprint(
                            17025902295854411478,
                            11375155654212205663,
                        ),
                    ),
                },
                trait_map: {},
            },
        ),
        Owner(
            OwnerInfo {
                nodes: OwnerNodes {
                    node: Some(
                        ParentedNode {
                            parent: 4294967040,
                            node: Item(
                                Item {
                                    ident: #0,
                                    owner_id: DefId(0:1 ~ toy[5100]::{use#0}),
                                    kind: Use(
                                        Path {
                                            span: no-location (#1),
                                            res: [
                                                Err,
                                            ],
                                            segments: [
                                                PathSegment {
                                                    ident: std#1,
                                                    hir_id: HirId(DefId(0:1 ~ toy[5100]::{use#0}).1),
                                                    res: Def(
                                                        Mod,
                                                        DefId(1:0 ~ std[7da8]),
                                                    ),
                                                    args: None,
                                                    infer_args: false,
                                                },
                                                PathSegment {
                                                    ident: prelude#1,
                                                    hir_id: HirId(DefId(0:1 ~ toy[5100]::{use#0}).2),
                                                    res: Def(
                                                        Mod,
                                                        DefId(1:47 ~ std[7da8]::prelude),
                                                    ),
                                                    args: None,
                                                    infer_args: false,
                                                },
                                                PathSegment {
                                                    ident: rust_2021#1,
                                                    hir_id: HirId(DefId(0:1 ~ toy[5100]::{use#0}).3),
                                                    res: Def(
                                                        Mod,
                                                        DefId(1:134 ~ std[7da8]::prelude::rust_2021),
                                                    ),
                                                    args: None,
                                                    infer_args: false,
                                                },
                                            ],
                                        },
                                        Glob,
                                    ),
                                    span: no-location (#1),
                                    vis_span: no-location (#1),
                                },
                            ),
                        },
                    ),
                    parents: [
                        (0, Some(4294967040)),
                        (1, Some(0)),
                        (2, Some(0)),
                        (3, Some(0)),
                    ],
                    bodies: {},
                    opt_hash_including_bodies: Some(
                        Fingerprint(
                            9776095397668046631,
                            18155842398969312934,
                        ),
                    ),
                },
                parenting: {},
                attrs: AttributeMap {
                    map: {
                        0: [
                            Attribute {
                                kind: Normal(
                                    NormalAttr {
                                        item: AttrItem {
                                            path: Path {
                                                span: no-location (#1),
                                                segments: [
                                                    PathSegment {
                                                        ident: prelude_import#1,
                                                        id: NodeId(2),
                                                        args: None,
                                                    },
                                                ],
                                                tokens: None,
                                            },
                                            args: Empty,
                                            tokens: None,
                                        },
                                        tokens: None,
                                    },
                                ),
                                id: AttrId(1),
                                style: Outer,
                                span: no-location (#1),
                            },
                        ],
                    },
                    opt_hash: Some(
                        Fingerprint(
                            4378549281862600855,
                            17998491422310851028,
                        ),
                    ),
                },
                trait_map: {},
            },
        ),
        Owner(
            OwnerInfo {
                nodes: OwnerNodes {
                    node: Some(
                        ParentedNode {
                            parent: 4294967040,
                            node: Item(
                                Item {
                                    ident: std#1,
                                    owner_id: DefId(0:2 ~ toy[5100]::std),
                                    kind: ExternCrate(
                                        None,
                                    ),
                                    span: no-location (#1),
                                    vis_span: no-location (#1),
                                },
                            ),
                        },
                    ),
                    parents: [
                        (0, Some(4294967040)),
                    ],
                    bodies: {},
                    opt_hash_including_bodies: Some(
                        Fingerprint(
                            3711634980894625781,
                            12101783316897509037,
                        ),
                    ),
                },
                parenting: {},
                attrs: AttributeMap {
                    map: {
                        0: [
                            Attribute {
                                kind: Normal(
                                    NormalAttr {
                                        item: AttrItem {
                                            path: Path {
                                                span: no-location (#1),
                                                segments: [
                                                    PathSegment {
                                                        ident: macro_use#1,
                                                        id: NodeId(7),
                                                        args: None,
                                                    },
                                                ],
                                                tokens: None,
                                            },
                                            args: Empty,
                                            tokens: None,
                                        },
                                        tokens: None,
                                    },
                                ),
                                id: AttrId(0),
                                style: Outer,
                                span: no-location (#1),
                            },
                        ],
                    },
                    opt_hash: Some(
                        Fingerprint(
                            14616371245818135626,
                            2897433832207639290,
                        ),
                    ),
                },
                trait_map: {},
            },
        ),
        Owner(
            OwnerInfo {
                nodes: OwnerNodes {
                    node: Some(
                        ParentedNode {
                            parent: 4294967040,
                            node: Item(
                                Item {
                                    ident: main#0,
                                    owner_id: DefId(0:3 ~ toy[5100]::main),
                                    kind: Fn(
                                        FnSig {
                                            header: FnHeader {
                                                unsafety: Normal,
                                                constness: NotConst,
                                                asyncness: NotAsync,
                                                abi: Rust,
                                            },
                                            decl: FnDecl {
                                                inputs: [],
                                                output: DefaultReturn(
                                                    src/main.rs:1:10: 1:10 (#0),
                                                ),
                                                c_variadic: false,
                                                implicit_self: None,
                                                lifetime_elision_allowed: false,
                                            },
                                            span: src/main.rs:1:1: 1:10 (#0),
                                        },
                                        Generics {
                                            params: [],
                                            predicates: [],
                                            has_where_clause_predicates: false,
                                            where_clause_span: src/main.rs:1:10: 1:10 (#0),
                                            span: src/main.rs:1:8: 1:8 (#0),
                                        },
                                        BodyId {
                                            hir_id: HirId(DefId(0:3 ~ toy[5100]::main).11),
                                        },
                                    ),
                                    span: src/main.rs:1:1: 3:2 (#0),
                                    vis_span: no-location (#0),
                                },
                            ),
                        },
                    ),
                    parents: [
                        (0, Some(4294967040)),
                        (1, Some(10)),
                        (2, Some(8)),
                        (3, Some(2)),
                        (4, Some(5)),
                        (5, Some(3)),
                        (6, Some(3)),
                        (7, Some(2)),
                        (8, Some(1)),
                        (9, Some(8)),
                        (10, Some(11)),
                        (11, Some(0)),
                    ],
                    bodies: {
                        11: Body {
                            params: [],
                            value: Expr {
                                hir_id: HirId(DefId(0:3 ~ toy[5100]::main).11),
                                kind: Block(
                                    Block {
                                        stmts: [
                                            Stmt {
                                                hir_id: HirId(DefId(0:3 ~ toy[5100]::main).1),
                                                kind: Local(
                                                    Local {
                                                        pat: Pat {
                                                            hir_id: HirId(DefId(0:3 ~ toy[5100]::main).9),
                                                            kind: Binding(
                                                                BindingAnnotation(
                                                                    No,
                                                                    Not,
                                                                ),
                                                                HirId(DefId(0:3 ~ toy[5100]::main).9),
                                                                bob#0,
                                                                None,
                                                            ),
                                                            span: src/main.rs:2:9: 2:12 (#0),
                                                            default_binding_modes: true,
                                                        },
                                                        ty: None,
                                                        init: Some(
                                                            Expr {
                                                                hir_id: HirId(DefId(0:3 ~ toy[5100]::main).2),
                                                                kind: Call(
                                                                    Expr {
                                                                        hir_id: HirId(DefId(0:3 ~ toy[5100]::main).3),
                                                                        kind: Path(
                                                                            TypeRelative(
                                                                                Ty {
                                                                                    hir_id: HirId(DefId(0:3 ~ toy[5100]::main).5),
                                                                                    kind: Path(
                                                                                        Resolved(
                                                                                            None,
                                                                                            Path {
                                                                                                span: src/main.rs:2:15: 2:18 (#0),
                                                                                                res: Def(
                                                                                                    Struct,
                                                                                                    DefId(5:276 ~ alloc[1281]::boxed::Box),
                                                                                                ),
                                                                                                segments: [
                                                                                                    PathSegment {
                                                                                                        ident: Box#0,
                                                                                                        hir_id: HirId(DefId(0:3 ~ toy[5100]::main).4),
                                                                                                        res: Def(
                                                                                                            Struct,
                                                                                                            DefId(5:276 ~ alloc[1281]::boxed::Box),
                                                                                                        ),
                                                                                                        args: None,
                                                                                                        infer_args: true,
                                                                                                    },
                                                                                                ],
                                                                                            },
                                                                                        ),
                                                                                    ),
                                                                                    span: src/main.rs:2:15: 2:18 (#0),
                                                                                },
                                                                                PathSegment {
                                                                                    ident: new#0,
                                                                                    hir_id: HirId(DefId(0:3 ~ toy[5100]::main).6),
                                                                                    res: Err,
                                                                                    args: None,
                                                                                    infer_args: true,
                                                                                },
                                                                            ),
                                                                        ),
                                                                        span: src/main.rs:2:15: 2:23 (#0),
                                                                    },
                                                                    [
                                                                        Expr {
                                                                            hir_id: HirId(DefId(0:3 ~ toy[5100]::main).7),
                                                                            kind: Lit(
                                                                                Spanned {
                                                                                    node: Int(
                                                                                        1,
                                                                                        Unsuffixed,
                                                                                    ),
                                                                                    span: src/main.rs:2:24: 2:25 (#0),
                                                                                },
                                                                            ),
                                                                            span: src/main.rs:2:24: 2:25 (#0),
                                                                        },
                                                                    ],
                                                                ),
                                                                span: src/main.rs:2:15: 2:26 (#0),
                                                            },
                                                        ),
                                                        els: None,
                                                        hir_id: HirId(DefId(0:3 ~ toy[5100]::main).8),
                                                        span: src/main.rs:2:5: 2:27 (#0),
                                                        source: Normal,
                                                    },
                                                ),
                                                span: src/main.rs:2:5: 2:27 (#0),
                                            },
                                        ],
                                        expr: None,
                                        hir_id: HirId(DefId(0:3 ~ toy[5100]::main).10),
                                        rules: DefaultBlock,
                                        span: src/main.rs:1:11: 3:2 (#0),
                                        targeted_by_break: false,
                                    },
                                    None,
                                ),
                                span: src/main.rs:1:11: 3:2 (#0),
                            },
                            generator_kind: None,
                        },
                    },
                    opt_hash_including_bodies: Some(
                        Fingerprint(
                            17038548455900965345,
                            6128119105717993704,
                        ),
                    ),
                },
                parenting: {},
                attrs: AttributeMap {
                    map: {},
                    opt_hash: Some(
                        Fingerprint(
                            17025902295854411478,
                            11375155654212205663,
                        ),
                    ),
                },
                trait_map: {
                    3: [],
                },
            },
        ),
    ],
    opt_hir_hash: Some(
        Fingerprint(
            13212131797653419263,
            9623007000143043823,
        ),
    ),
}

```


**MIR**
Obtain the MIR of the source code 
```
cargo rustc -- -Zunpretty=mir
```

```
fn main() -> () {
    let mut _0: ();
    let _1: std::boxed::Box<i32>;
    scope 1 {
        debug bob => _1;
    }

    bb0: {
        _1 = Box::<i32>::new(const 1_i32) -> [return: bb1, unwind continue];
    }

    bb1: {
        drop(_1) -> [return: bb2, unwind continue];
    }

    bb2: {
        return;
    }
}
```

## Terminalogies

 - [**TyCtxt**](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.TyCtxt.html) is the central data structure of Rust compilers. We can obtain the hir or mir of a function based on the object.
```rust
let hir = tcx.hir();
let mir = optimized_mir(def_id); // def_id is of type DefId
```
 - [**DefId**](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_span/def_id/struct.DefId.html): 
 - [**Local**](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Local.html):
 - [**LocalDecl**](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.LocalDecl.html):

